<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Lists</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
</head>

<body>

    <h1 id="greeting">Hello, <span id="username"></span></h1>

    <!-- Button to open the modal for adding a new list -->
    <button id="openAddListModal" class="btn btn-primary">Add New List</button>

    <!-- Table for displaying lists -->
    <!-- <table id="listsTable">
        <thead>
            <tr>
                <th>Title</th>
                <th>Description</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- List content will be added here via JavaScript -->
        <!-- </tbody>
    </table> --> -->

    <div id="displayData">
        <table id="listsTable">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>





    <!-- Modal for adding a new list -->
    <div id="addListModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeAddModal">&times;</span>
            <h2>Add New List</h2>
            <input type="text" id="listTitle" placeholder="List Title" required>
            <textarea id="listDescription" placeholder="List Description" required></textarea>
            <button id="submitList" class="btn btn-success">Add List</button>
        </div>
    </div>

    <!-- Modal for editing an existing list -->
    <div id="editListModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeEditModal">&times;</span>
            <h2>Edit List</h2>
            <input type="text" id="editListTitle" placeholder="New Title" required>
            <textarea id="editListDescription" placeholder="New Description" required></textarea>
            <input type="text" id="sharedUser" placeholder="Share with user (email)" required>
            <button id="submitEditList" class="btn btn-success">Save Changes</button>
        </div>
    </div>

    <script>
        const SERVER = 'http://127.0.0.1:8000/listitem/';

        // Load username from localStorage and set in greeting
        const username = localStorage.getItem('username') || 'Guest';
        document.getElementById('username').innerText = username;

        // Display data function
        const displayData = () => {
        axios.get(SERVER)
            .then(res => {
                const lists = res.data;
                const tbody = document.querySelector('#listsTable tbody');
                tbody.innerHTML = ''; // Clear previous content

                // Filter and display only active lists
                lists.filter(list => list.is_active).forEach(function(list) {
                    const tr = document.createElement('tr');
                    tr.setAttribute('data-list-id', list.id);  // Set list ID as an attribute
                    tr.innerHTML = `
                        <td>${list.title}</td>
                        <td>${list.description}</td>
                        <td>
                            <button class="btn btn-warning" onclick="openEditModal(${list.id}, '${list.title}', '${list.description}')">Edit</button>
                            <button class="btn btn-danger" onclick="markListAsInactive(${list.id})">Mark as Inactive</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            })
            .catch(error => {
                console.error('There was an error fetching the data!', error);
            });
    }

    // Load the data when the page opens
    window.onload = displayData;






        // // Fetch only active lists
        // function fetchLists() {
        //     axios.get(SERVER, {
        //         headers: {
        //             'Authorization': 'Bearer ' + localStorage.getItem('access_token')
        //         }
        //     })
        //         .then(function (response) {
        //             console.log(response.data);  // Print the response data
        //             displayData(response.data); // Call displayData with the fetched lists
        //         })
        //         .catch(function (error) {
        //             console.error('Error fetching lists:', error); // Print error to console
        //             alert('Error fetching lists: ' + (error.response ? error.response.data : error.message));
        //         });
        // }

        // Fetch only active lists
        // function fetchLists() {
        //     axios.get(SERVER, {
        //         headers: {
        //             'Authorization': 'Bearer ' + localStorage.getItem('access_token')
        //         }
        //     })
        //         .then(function (response) {
        //             console.log(response.data);  // Print the response data

        //             var tbody = document.querySelector('#listsTable tbody');
        //             tbody.innerHTML = ''; // Clear previous content

        //             // Show only active lists
        //             response.data.filter(list => list.is_active).forEach(function (list) {
        //                 var tr = document.createElement('tr');
        //                 tr.setAttribute('data-list-id', list.id);  // Set ID as attribute
        //                 tr.innerHTML = `
        //         <td>${list.title}</td>
        //         <td>${list.description}</td>
        //         <td>
        //             <button class="btn btn-warning" onclick="openEditModal(${list.id}, '${list.title}', '${list.description}')">Edit</button>
        //             <button class="btn btn-danger" onclick="markListAsInactive(${list.id})">Mark as Inactive</button>
        //         </td>
        //     `;
        //                 tbody.appendChild(tr);
        //             });
        //         })
        //         .catch(function (error) {
        //             console.error('Error fetching lists:', error); // Print error to console
        //             alert('Error fetching lists: ' + (error.response ? error.response.data : error.message));
        //         });
        // }


        // Mark list as inactive
        function markListAsInactive(listId) {
            axios.put(`${SERVER}${listId}/`, {
                is_active: false // Mark list as inactive
            }, {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                }
            })
                .then(function (response) {
                    alert('List marked as inactive successfully!');
                    removeListFromTable(listId);
                })
                .catch(function (error) {
                    console.error('Error details:', error.response.data);
                    alert('Error marking list as inactive: ' + (error.response ? error.response.data : error.message));
                });
        }

        // Open edit modal with existing list details
        function openEditModal(listId, title, description) {
            document.getElementById('editListTitle').value = title;
            document.getElementById('editListDescription').value = description;
            document.getElementById('editListModal').setAttribute('data-list-id', listId);
            document.getElementById('editListModal').style.display = 'block';
        }

        // Submit the edited list
        document.getElementById('submitEditList').onclick = function () {
            var listId = document.getElementById('editListModal').getAttribute('data-list-id');
            var newTitle = document.getElementById('editListTitle').value;
            var newDescription = document.getElementById('editListDescription').value;
            var sharedUser = document.getElementById('sharedUser').value;

            axios.put(`${SERVER}${listId}/`, {
                title: newTitle,
                description: newDescription,
                shared_user: sharedUser // Share with a user by email
            }, {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                }
            })
                .then(function (response) {
                    alert('List updated successfully!');
                    fetchLists();  // Refresh lists after editing
                    document.getElementById('editListModal').style.display = 'none'; // Close modal
                })
                .catch(function (error) {
                    alert('Error updating list: ' + (error.response ? error.response.data : error.message));
                });
        }

        // Add a new list
        document.getElementById('submitList').onclick = function () {
            // שליפת כותרת ותיאור מהרשימה
            var title = document.getElementById('listTitle').value;
            var description = document.getElementById('listDescription').value;

            // שליפת ה-owner_id מ-localStorage
            var userId = localStorage.getItem('user_id');

            // וידוא שהמשתמש מחובר ויש לו user_id
            if (!userId) {
                alert('User is not authenticated. Please log in.');
                return;
            }

            // שליחת בקשת POST עם ה-owner_id שנשמר
            axios.post(SERVER, {
                title: title,
                description: description,
                owner: localStorage.getItem('user_id')  // הוספת ה-user_id לבקשה
            }, {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                }
            })
                .then(function (response) {
                    alert('List added successfully!');
                    fetchLists();  // Refresh lists after adding
                    document.getElementById('addListModal').style.display = 'none'; // Close modal
                })
                .catch(function (error) {
                    alert('Error adding list: ' + (error.response ? error.response.data : error.message));
                });



            // Function to remove a list from the table UI after deactivation
            function removeListFromTable(listId) {
                const tbody = document.querySelector('#listsTable tbody');
                const rows = tbody.getElementsByTagName('tr');

                // Find the row with the matching ID and remove it
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.getAttribute('data-list-id') == listId) {
                        tbody.removeChild(row);  // Remove the row from the table
                        break;
                    }
                }
            }

            // Open modal for adding a new list
            document.getElementById('openAddListModal').onclick = function () {
                document.getElementById('addListModal').style.display = 'block';
            }
        }

    </script>
</body>

</html>