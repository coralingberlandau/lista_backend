<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Lists</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
</head>

<body>

    <h1 id="greeting">Hello, <span id="username"></span></h1>

    <div id="displayData">
        <table id="listsTable">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <input type="color">

    <script>
        const SERVER = 'http://127.0.0.1:8000/listitem/';

        // Load username from localStorage and set in greeting
        const username = localStorage.getItem('username') || 'Guest';
        document.getElementById('username').innerText = username;

        const userId = localStorage.getItem('user_id');


        // Display only lists that belong to the current user and are active
        const displayData = () => {
            axios.get(`${SERVER}${listId}/`)
                .then(res => {
                    console.log(res.data); // הדפסת הנתונים כדי לבדוק מה מוחזר מהשרת

                    const tbody = document.querySelector('#listsTable tbody');
                    tbody.innerHTML = ''; // ניקוי תוכן קודם

                    // סינון לפי owner ולפי סטטוס פעיל
                    res.data.filter(list => list.owner === parseInt(userId) && list.is_active)
                        .forEach(function (list) {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${list.title}</td>
                                <td>${list.description}</td>
                                <td>
                                    <button onclick="openEditModal(${list.id}, '${list.title}', '${list.description}')">Edit</button>
                                    <button onclick="deleteData(${list.id})">Delete</button>
                                    <button onclick="shareList(${list.id})">Share</button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                })
                .catch(error => {
                    console.error('There was an error fetching the data!', error);
                });
        };



        const addData = () => {
            axios.post(SERVER)

        }




        // const updData = () => {
        //     axios.put()
        // }

        const openEditModal = (listId, title, description) => {
            const newTitle = prompt("Update title:", title);
            const newDescription = prompt("Update description:", description);

            if (newTitle !== null && newDescription !== null) {
                axios.put(`${SERVER}${listId}/`, {
                    title: newTitle,
                    description: newDescription
                })
                    .then(response => {
                        alert('List updated successfully!');
                        displayData(); // Refresh the list
                    })
                    .catch(error => {
                        console.error('There was an error updating the list!', error);
                    });
            }
        }





        // Do not delete from the data, only reverse is_active: false


        const deleteData = (listId) => {
            axios.patch(`${SERVER}${listId}/`, {
                is_active: false
            })
                .then(response => {
                    alert('List marked as inactive.');
                    displayData(); // Refresh the list
                })
                .catch(error => {
                    console.error('Error marking the list as inactive:', error);
                });
        }

        const shareList = (listId) => {
            const emailOrPhone = prompt("Enter email or phone number to share the list:");
            const permission = confirm("Full access? OK for full access, Cancel for read-only.");

            const permissionType = permission ? 'full_access' : 'read_only';

            axios.post(`${SERVER}${listId}/share/`, {
                email_or_phone: emailOrPhone,
                permission_type: permissionType
            })
                .then(response => {
                    alert('List shared successfully!');
                })
                .catch(error => {
                    console.error('Error sharing the list:', error);
                });
        }


        // Load lists when the page opens
        window.onload = displayData;

    </script>
</body>

</html>